---
layout: default
title: UTF-16ä¸emoji
---
<h1>{{ page.title }}</h1>
<p><img src="/blog/images/blog/abfbc34c30be57c03ea127a1c5887340.jpg" alt="æˆ‘çš„æ‰‹ç»˜ä¸å¯èƒ½è¿™ä¹ˆèŒ">
<a href="https://www.duitang.com/blog/?id=605367212">é¢˜å›¾å‡ºå¤„</a></p>
<p>{{ page.date | date_to_string }}</p>
<p>Author:wuguanxi</p>
<hr>
<h2>0 é—®é¢˜</h2>
<p>å…ˆæ¥çœ‹ä¸€æ®µä»£ç </p>
<pre><code class="language-javascript">  // é€¢3æ¢è¡Œ
  function wordBreak3(str) {
    return str.split(&quot;&quot;).reduce((pre,cur,index) =&gt; {
      const isBreak = (index % 3 === 0 &amp;&amp; index !== 0) ? &quot;\n&quot; : &quot;&quot;;
      return pre + isBreak + cur;
    },&quot;&quot;);
  }
  wordBreak3(&quot;abcdef&quot;);
  /*Â·Â·Â·
  * &quot;abc
  * def&quot;
  */
  wordBreak3(&quot;123456&quot;);
  /*
  * &quot;123
  * 456&quot;
  */
  wordBreak3(&quot;ä¸€äºŒä¸‰å››äº”å…­&quot;);
  /*
  * &quot;ä¸€äºŒä¸‰
  * å››äº”å…­&quot;
  */
</code></pre>
<p>ç®€å•çš„ä¸€æ®µä»£ç ï¼Œé€¢3æ¢è¡Œã€‚è¯•äº†å‡ ä¸ªä¾‹å­éƒ½æ²¡æœ‰é—®é¢˜ï¼Œç„¶åæˆ‘è¯•ç€æŠŠæˆ‘çš„å¾®ä¿¡åå­—å¤åˆ¶è¿›å»çœ‹çœ‹...</p>
<pre><code class="language-javascript">wordBreak3(&quot;ğŸ’¨ğŸ’¨ç¦§ğŸ³&quot;);
/*
* &quot;ğŸ’¨ï¿½
* ï¿½ç¦§ï¿½
* ï¿½&quot;
*/
// WTF!?
</code></pre>
<p>WTF?</p>
<p>å¾ˆæ˜æ˜¾ï¼Œ<code>wordBreak3</code>è¿™æ®µä»£ç æœ‰bugï¼Œä¸èƒ½æ­£ç¡®è¯†åˆ«emojiã€‚</p>
<h2>1 èƒŒæ™¯çŸ¥è¯†Unicodeä¸UTF-16ä¸UCS-2</h2>
<p>åœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­æˆ‘æœç´¢äº†å¤§é‡çš„ç½‘ç«™ï¼Œå‘ç°äº†ä»¥å‰ä¸çŸ¥é“çš„å¤§é‡JSå­—ç¬¦ä¸²ç›¸å…³çš„çŸ¥è¯†ï¼Œä»unicodeåˆ°UTF-16åˆ°UCS-2ã€‚å…¶ä¸­å°±é˜®ä¸€å³°è€å¸ˆçš„è¿™ç¯‡åšå®¢<a href="http://www.ruanyifeng.com/blog/2014/12/unicode.html">â€œUnicodeä¸JavaScriptè¯¦è§£â€</a>è®²å¾—æœ€å½»åº•ã€‚</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯ç”±äºJavaScriptåªèƒ½å¤„ç†UCS-2ç¼–ç ï¼Œé€ æˆæ‰€æœ‰å­—ç¬¦åœ¨è¿™é—¨è¯­è¨€ä¸­éƒ½æ˜¯2ä¸ªå­—èŠ‚ï¼Œå¦‚æœæ˜¯4ä¸ªå­—èŠ‚çš„å­—ç¬¦ï¼Œä¼šå½“ä½œä¸¤ä¸ªåŒå­—èŠ‚çš„å­—ç¬¦å¤„ç†ã€‚JavaScriptçš„å­—ç¬¦å‡½æ•°éƒ½å—åˆ°è¿™ä¸€ç‚¹çš„å½±å“ï¼Œæ— æ³•è¿”å›æ­£ç¡®ç»“æœã€‚</p>
<p>ä»¥emojiğŸ’¨ä¸ºä¾‹ï¼Œå®ƒçš„UTF-16ç¼–ç æ˜¯4ä¸ªå­—èŠ‚çš„0xD83D 0xDCA8ã€‚é—®é¢˜å°±æ¥äº†ï¼Œ4ä¸ªå­—èŠ‚çš„ç¼–ç ä¸å±äºUCS-2ï¼ŒJavaScriptä¸è®¤è¯†ï¼Œåªä¼šæŠŠå®ƒçœ‹ä½œå•ç‹¬çš„ä¸¤ä¸ªå­—ç¬¦U+D83Då’ŒU+DCA8ã€‚æ‰€ä»¥<code>&quot;ğŸ’¨&quot;.length === 2;</code>ä¸Šé¢çš„<code>wordBreak3</code>å‡½æ•°æ²¡æœ‰æ­£ç¡®å¤„ç†ï¼Œå°±æŠŠ&quot;ğŸ’¨&quot;æˆªå¼€æˆä¸¤åŠã€‚</p>
<h2>2 è§£å†³æ–¹æ³•</h2>
<h3>ES6ç‰ˆæœ¬</h3>
<p>å¤§å¹…å¢å¼ºäº†Unicodeæ”¯æŒï¼ŒåŸºæœ¬ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<pre><code class="language-javascript">  for  of 
  Array.from
  [...]
  éƒ½èƒ½æ­£ç¡®è¯†åˆ«
</code></pre>
<pre><code class="language-javascript">function stringToArrayReal(str){
  return [...str];
}
</code></pre>
<h3>ES5ç‰ˆæœ¬</h3>
<pre><code class="language-javascript">function stringToArrayReal(str){
  var index = 0;
  var length = str.length;
  var output = [];
  var character;
  var characterNext;
  var charCode;
  var charNextCode;
  while (index &lt; length){
    charCode = str.charCodeAt(index);
    charNextCode = str.charCodeAt(index + 1);
    character = str.charAt(index);
    characterNext = str.charAt(index + 1);
    if(charCode &gt;= 0xD800 
    &amp;&amp; charCode &lt;= 0xDBFF 
    &amp;&amp; charNextCode &gt;= 0xDC00 
    &amp;&amp; charNextCode &lt;= 0xDFFF) {
      output.push(character + characterNext);
      index += 2;
    } else {
      output.push(character);
      index ++;
    }
  }
  return output;
}
</code></pre>
<p>æœ‰å‡ ä¸ªç¥å¥‡çš„æ•°å­—0xD800ã€0xDBFFã€0xDC00ã€0xDFFFï¼Œæ˜¯æ¥è‡ªUTF-16çš„ç¼–ç è§„èŒƒã€‚WIKIé‡Œæœ‰è¯¦ç»†è§£æ<a href="https://zh.wikipedia.org/wiki/UTF-16">UTF-16</a></p>
<h2>SP å…¶ä»–å¥½ç©çš„emoji</h2>
<p>å¯ä»¥ä½¿ç”¨U+200Dé›¶å®½è¿å­—(ZWJ)å°†ä¸¤ä¸ªemojiè¿èµ·æ¥ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªemojiã€‚ï¼ˆä¸æ”¯æŒçš„ç³»ç»Ÿä¼šå¿½ç•¥é›¶å®½è¿å­—ï¼‰</p>
<p>ä¾‹å¦‚U+1F468ç”·äººã€U+200D ZWJã€U+1F469å¥³äººã€U+200D ZWJã€U+1F467å¥³å­©(ğŸ‘¨â€ğŸ‘©â€ğŸ‘§)åœ¨ç³»ç»Ÿæ”¯æŒçš„æƒ…å†µä¸‹ä¼šæ˜¾ç¤ºä¸ºä¸€ä¸ªç”·äººä¸€ä¸ªå¥³äººå’Œä¸€ä¸ªå¥³å­©ç»„æˆçš„å®¶åº­emojiï¼Œè€Œä¸æ”¯æŒçš„ç³»ç»Ÿåˆ™ä¼šé¡ºåºæ˜¾ç¤ºè¿™ä¸‰ä¸ªemoji(ğŸ‘¨ğŸ‘©ğŸ‘§)ã€‚</p>
<p>æŸ¥çœ‹æ‰€æœ‰çš„<a href="http://www.unicode.org/Public/emoji/12.0/emoji-zwj-sequences.txt">emoji-zwj-sequences</a></p>
